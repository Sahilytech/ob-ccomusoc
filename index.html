<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Observatorio CCOMUSOC Interactivo</title>

<!-- Fuentes -->
<link href="https://fonts.googleapis.com/css2?family=Anton&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --color-primario: #0e98d6;
  --color-blanco: #ffffff;
  --color-negro: #000000;
  --color-rojo: #ff0000;
  --color-amarillo: #ffcd02;
  --color-verde: #6b8e23;
  --color-rosa: #ffeb5;
}

body {
  margin: 0;
  font-family: 'Montserrat', sans-serif;
  background-color: var(--color-blanco);
  color: var(--color-negro);
}

header {
  background-color: var(--color-primario);
  color: var(--color-blanco);
  padding: 1rem;
  text-align: center;
  font-family: 'Anton', sans-serif;
  font-size: 2rem;
}

main {
  max-width: 1200px;
  margin: 2rem auto;
  padding: 0 1rem;
}

h2 {
  font-family: 'Anton', sans-serif;
  color: var(--color-primario);
  margin-top: 2rem;
  margin-bottom: 1rem;
}

input, select, button {
  padding: 0.5rem;
  margin-right: 0.5rem;
  font-size: 1rem;
}

button {
  cursor: pointer;
  background-color: var(--color-primario);
  color: var(--color-blanco);
  border: none;
  border-radius: 4px;
}

.grafico-container {
  background-color: #f8f8f8;
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 2rem;
}

.fuente {
  font-size: 0.8rem;
  color: #555;
  text-align: right;
  margin-top: 0.5rem;
}

footer {
  background-color: var(--color-negro);
  color: var(--color-blanco);
  padding: 1rem;
  text-align: center;
  margin-top: 2rem;
}

#listaUrls li {
  margin-bottom: 0.3rem;
}

.panel-grafico {
  margin-top: 2rem;
}
.panel-grafico h3 {
  font-family: 'Anton', sans-serif;
  color: var(--color-primario);
  margin-bottom: 0.5rem;
}
.panel-grafico button {
  margin-top: 0.5rem;
}
</style>
</head>
<body>

<header>Observatorio CCOMUSOC Interactivo</header>

<main>
  <h2>Comparar Datos de URLs</h2>
  <input type="text" id="urlInput" placeholder="Pegar URL (hasta 50)">
  <select id="tipoDato">
    <option value="porcentaje">Porcentaje (%)</option>
    <option value="numero">Número absoluto</option>
  </select>
  <select id="estrategia">
    <option value="ultimo">Último número</option>
    <option value="maximo">Máximo número</option>
    <option value="promedio">Promedio de números</option>
  </select>
  <button onclick="agregarURL()">Agregar URL</button>
  <button onclick="generarGraficos()">Generar Gráficos</button>

  <ul id="listaUrls"></ul>

  <div class="panel-grafico">
    <h3>Gráfico de Barras</h3>
    <canvas id="graficoBarras"></canvas>
    <button onclick="descargarGrafico('graficoBarras')">Descargar PNG</button>
    <div class="fuente" id="fuentesBarras"></div>
  </div>

  <div class="panel-grafico">
    <h3>Gráfico de Torta</h3>
    <canvas id="graficoTorta"></canvas>
    <button onclick="descargarGrafico('graficoTorta')">Descargar PNG</button>
    <div class="fuente" id="fuentesTorta"></div>
  </div>

  <div class="panel-grafico">
    <h3>Gráfico de Línea</h3>
    <canvas id="graficoLinea"></canvas>
    <button onclick="descargarGrafico('graficoLinea')">Descargar PNG</button>
    <div class="fuente" id="fuentesLinea"></div>
  </div>
</main>

<footer>
  Observatorio CCOMUSOC - Datos oficiales y fuentes públicas
</footer>

<script>
let urls = [];
let chartBarras, chartTorta, chartLinea;

// Agregar URL
function agregarURL() {
  const input = document.getElementById('urlInput');
  const url = input.value.trim();
  if (!url) return;
  if (urls.length >= 50) return alert("Máximo 50 URLs");
  if (!urls.some(u => u.url === url)) {
    urls.push({ url, tipo: document.getElementById('tipoDato').value });
    const li = document.createElement('li');
    li.textContent = `${url} (${document.getElementById('tipoDato').value})`;
    document.getElementById('listaUrls').appendChild(li);
    input.value = '';
  }
}

// Extraer números
function extraerNumeros(texto, tipo) {
  let regex = tipo === 'porcentaje' ? /\d+(\.\d+)?\s*%/g : /\d[\d,.]*/g;
  let matches = texto.match(regex) || [];
  return matches.map(n => parseFloat(n.replace(/\./g,'').replace(',','.').replace('%','')));
}

// Estrategia
function calcularValor(numeros, estrategia){
  if(numeros.length === 0) return 0;
  if(estrategia==='ultimo') return numeros[numeros.length-1];
  if(estrategia==='maximo') return Math.max(...numeros);
  if(estrategia==='promedio') return numeros.reduce((a,b)=>a+b,0)/numeros.length;
  return numeros[numeros.length-1];
}

// Descargar gráfico
function descargarGrafico(idCanvas){
  const canvas=document.getElementById(idCanvas);
  const link=document.createElement('a');
  link.download=idCanvas+'.png';
  link.href=canvas.toDataURL();
  link.click();
}

// Generar gráficos
async function generarGraficos() {
  if(urls.length===0) return alert("Agregá al menos una URL");

  const estrategia=document.getElementById('estrategia').value;
  const labels=[], valores=[], fuentes=[];

  for(const u of urls){
    try{
      const res=await fetch(`https://ccomusoc-ob.sarahleeoliveraok.workers.dev/?url=${encodeURIComponent(u.url)}`);
      const data=await res.text();
      const parser=new DOMParser();
      const doc=parser.parseFromString(data,'text/html');
      const texto=doc.body.innerText;
      const numeros=extraerNumeros(texto,u.tipo);
      if(numeros.length===0) continue;
      const valor=calcularValor(numeros,estrategia);
      labels.push(u.url);
      valores.push(valor);
      fuentes.push(u.url);
    } catch(e){
      console.error('Error URL:',u.url,e);
    }
  }

  if(chartBarras) chartBarras.destroy();
  if(chartTorta) chartTorta.destroy();
  if(chartLinea) chartLinea.destroy();

  // Barras
  chartBarras=new Chart(document.getElementById('graficoBarras').getContext('2d'),{
    type:'bar',
    data:{ labels, datasets:[{label:'Comparación', data:valores, backgroundColor:labels.map(()=>'#'+Math.floor(Math.random()*16777215).toString(16))}] },
    options:{ responsive:true, animation:{duration:1000}, plugins:{legend:{display:false}} }
  });
  document.getElementById('fuentesBarras').textContent='Fuentes: '+fuentes.join(' | ');

  // Torta
  chartTorta=new Chart(document.getElementById('graficoTorta').getContext('2d'),{
    type:'pie',
    data:{ labels, datasets:[{data:valores, backgroundColor:labels.map(()=>'#'+Math.floor(Math.random()*16777215).toString(16))}] },
    options:{ responsive:true, animation:{duration:1000}, plugins:{legend:{position:'bottom'}} }
  });
  document.getElementById('fuentesTorta').textContent='Fuentes: '+fuentes.join(' | ');

  // Línea
  chartLinea=new Chart(document.getElementById('graficoLinea').getContext('2d'),{
    type:'line',
    data:{ labels, datasets:[{label:'Comparación', data:valores, borderColor:'#0e98d6', backgroundColor:'rgba(14,152,214,0.2)', fill:true, tension:0.3, pointBackgroundColor:'#0e98d6', pointRadius:5}] },
    options:{ responsive:true, animation:{duration:1000}, plugins:{legend:{display:false}} }
  });
  document.getElementById('fuentesLinea').textContent='Fuentes: '+fuentes.join(' | ');
}
</script>

</body>
</html>
